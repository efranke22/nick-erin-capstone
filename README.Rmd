---
title: "A Spatial Analysis of Elevated Blood Lead Levels in the Twin Cities Metropolitan Region"
author: "Erin Franke and Nicholas Di"
date: "May 6, 2022"
output: github_document
bibliography: Library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r, message=FALSE, warning=FALSE}
library(tidycensus)
library(tidyverse)
library(survey)
library(srvyr)
library(sf)
library(ggtext)
library(tidymodels)
library(spdep)
library(probably)
tidymodels_prefer()
conflicted::conflict_prefer("spautolm", "spatialreg")

#see DataCleaning.Rmd for data cleaning steps
load("DataShapefiles/lead_spatial.RData")
river_lakes <- st_read("DataShapefiles/shp_water_lakes_rivers")
roads <- st_read("DataShapefiles/tl_2019_27_prisecroads")
roads_sub <- st_crop(roads,st_bbox(lead_census))
```

# Introduction 

When raising a child, parents go through lots of stress to keep their children safe and healthy. From using car seats to getting children vaccinated to working on speech and mobility development and beyond, there is a lot to think about. But one thing that may be overlooked in providing safe and healthy environment for a child is lead. Lead in paint, soil, air, or water is invisible to the naked eye and has no smell [@cdcPrevention]. However, children can be exposed to lead in a variety of manners, including swallowing house dust or soil contaminated by lead paint or drinking water delivered through lead-based pipes, faucets, and plumbing fixtures. Exposure to this hidden element can seriously harm a child's health, including damage to the child's brain and nervous system, slowed growth and development, as well as learning, hearing, speech, and behavior problems [@cdcPrevention]. If exposed to especially high levels of lead, children can face a brain condition known as encephalopathy, severe neurological damage, coma, and even death [@leadoverview]. Thus, without a question it is crucial to keep lead exposure to a minimum when raising a child. 

In this analysis, we analyzed elevated blood lead levels in the **7-county Twin Cities metropolitan area** using public data provided by the **Minnesota Department of Health** over the period of 2015-2019 [@mdhdata]. To protect the privacy of individuals, the smallest granularity we were able to obtain this data was on the census tract level, meaning for each of the 691 census tracts in the Twin Cities metropolitan area we obtained information on how many children were tested and how many of those tests resulted in elevated blood lead levels. To have **elevated blood lead levels (EBLL)** means that a child has a confirmed result **at or above 5 micrograms of lead per deciliter of blood (mcg/dL)** [@leadoverview]. Children under 6 years of age are tested. The Minnesota Department of Health idenifies children living in the Minneapolis and Saint Paul city limits as children at a higher risk for lead exposure and recommends these children to receive blood lead testing at 1 and 2 years of age. This recommendation is warranted given that in 2019, between 1-2% of children in Minneapolis or St. Paul had an EBLL, which is double the statewide average and higher than any other region of Minnesota [@leadoverview]. Interestingly, the MDH has found children living in the Metro area but not living in the cities of Minneapolis or St. Paul are at a lower risk of lead exposure than the Greater Minnesota (non-Metro) are. Only about 0.3% of these children have high EBLL levels whereas about 0.8% of children living in MN outside the metro area have high EBLL levels. As a result, to best explore this contrast between Minneapolis-Saint Paul and the suburban region, this project will solely focus on EBLL data from the 7 county Twin Cities metro area. This region is shown in navy on the road map of Minnesota below. 

```{r}
lead_census %>%
  ggplot()+
  geom_sf(fill = "navy", lwd = 0.2, color = "navy")+
  geom_sf(data = roads, fill = "lightblue",color = "lightblue", lwd=0.2)+
  theme_classic()+
  labs(title = "Twin Cities Metropolitan region on MN road map")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red"))
```

# Research Goal

Keeping the health consequences of lead exposure to children in the front of our minds, our research focuses on investigating what is correlated with a census tract having a noticeably high proportion of children testing with elevated blood lead levels. We defined a tract to be a "high lead tract" if at least 1% of the tests in the tract resulted in elevated blood lead levels (meaning 5+ mcg lead/dL). This left us with 106 "high lead" tracts and 585 "safe" tracts. The location of these "high lead" tracts in the Twin Cities metropolitan area can be seen below. It is clear that the majority of them fall in the Minneapolis-Saint Paul city limits. 

```{r}
river_lakes_big <- river_lakes %>%
  filter(AREA_ACRES >= 500)
roads_metro <- st_crop(roads,st_bbox(lead_census))
lead_census %>%
  ggplot()+
  geom_sf(aes(fill=as.factor(HighLead)), lwd = 0.2, color = "white")+
  geom_sf(data = river_lakes_big, fill = "lightblue",color = "lightblue")+
  theme_classic()+
  labs(title = "Elevated blood lead levels in the Twin Cities", subtitle = "<strong><span style='color:red'>Red tracts have at least 1% of children tested with high elevated blood levels</span></strong></b>")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red"))
```

The reason why this research question is important is because understanding what is correlated with tracts having high lead levels can help the Minnesota Department of Health, organizations, and families protect children from lead exposure. For example, it wouldn't be unreasonable to expect tracts with older homes to have higher lead levels, as these homes are more likely to have been built when science did not know the harms of lead pipes and paint. On March 28, 2022, Saint Paul Mayor Melvin Carter announced a $14.5 million American Rescue Plan investment to remove thousands of lead pipes across the city [@saintpaul]. If home age appears a strong indicator of high lead levels, identifying tracts with old homes, high lead levels, and lots of young children can alert the city to replace their pipes first. In our research we also might search for a relationship between testing, income, and lead levels. If we are to find certain income groups getting tested more or less than others holding other variables constant, we can shed light on that and advocate for resources to get specific tracts the testing they need and deserve given their exposure. 

To help us understand what is correlated with a tract being "high lead", we will need more than just the information provided by the MDH of tract lead levels. Using the **tidycensus** [@tidycensus] package in R, we can access a plethora of information on each census tract including its estimated mean age, mean income, population, proportion of family households, home age, and so much more. We begin by exploring the relationship between many of these variables and testing as well as EBLLs.

# Exploratory Data Analysis 

## Estimated Home Age and EBLLs

One of the first variables we decided to explore was estimated home age. Using the tidycensus package, we were able to access the number of residences in each census tract built prior to 1950, between 1950-1959, 1960-1969, etc. We made these variables proportions by dividing the number of homes built in each time period by the total number of homes in the census tract. Most revealing was the proportion of homes built prior to 1950 - as seen in the map below, the Minneapolis-Saint Paul city limits are largely composed of these older homes while the tracts on the outskirts of the city have few very homes built before 1950.

```{r}
lead_census %>%
  ggplot()+
  geom_sf(aes(fill = propHomesBuiltPre1950), lwd = 0.2, color = "white")+
  theme_classic()+
  labs(title = "Proportion of homes built before 1950 by Twin Cities census tract", fill = "")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 9))+
  scale_fill_viridis_c()
```

Given this visualization and our knowledge of history, it is clear that home age likely plays a strong role in lead exposure in children. But it can't be the only factor. In the map below, we again identify tracts with at least 1% of tests registering with elevated blood lead levels. These tracts are colored red and pink, though *in the pink tracts less than 25% of homes were built before 1950*. We see these pink tracts generally are located outside the MSP city limits in more recently developed suburban areas. 

```{r}
lead_census %>%
  mutate(highleadNewHome = case_when(HighLead == "1" & propHomesBuiltPre1950 <= 0.25 ~ 2, 
                                     HighLead == "1" & propHomesBuiltPre1950 > 0.25 ~ 1,
                                     TRUE ~ 0)) %>%
  ggplot()+
  geom_sf(aes(fill=as.factor(highleadNewHome)), lwd = 0.2, color = "white")+
  geom_sf(data = river_lakes_big, fill = "lightblue",color = "lightblue")+
  theme_classic()+
  labs(title = "Elevated blood lead levels in the Twin Cities", subtitle = "<strong><span style='color:red'>Red and pink tracts have at least 1% of children tested with EBLLs </span></strong></b>")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono"), 
        plot.subtitle = element_markdown(family = "mono", size = 8))+
  scale_fill_manual(values = c("navy", "red", "pink"))
```

Comparing these pink tracts we have denoted as "high lead" tracts that contain less than 25% of homes built before 1950 to tracts we have denoted as having safe lead levels, there are a few things to notice. Our first thought was that perhaps these pink tracts were still significantly older than the safe lead level tracks and were just built largely in the 1960s and 70s. Lead-based paint and lead-contaminated dust are the most common sources of lead poisoning, and paint containing lead was not banned in the United States until 1978 [@washHealth]. Therefore, any home built prior to 1978 could serve as an exposure threat to children. It ended up that on average 56.1% percent of the homes in the pink tracts were built before 1979 compared to 54.8% of homes in the safe lead tracts. With such a small difference, there has to be something else correlated with children testing for EBLLs in particular tracts. Looking into other variables, we found the pink high lead tracts have a slightly higher population density at about 2 people/1000 $\text{m}^2$ than the safe lead tracts at 1.4 people/1000 $\text{m}^2$. Additionally, these pink high lead tracts have an estimated median income of \$63,431, whereas the safe lead tracts have an estimated median income of almost \$87,661. Lead exposure can also come through occupation (people exposed to lead through jobs in fields such as auto repair, mining, pipe fitting, battery manufacturing, painting, and construction can bring it home on their clothing), soil, pottery, herbal and folk remedies, the ingredient tamarind in candy, and cosmetics [@mayo]. Given the significant difference in median income between the pink high lead tracts and the safe lead tracts, it is possible that residents from the pink high lead tracts live a different lifestyle than residents in the safe lead tracts that causes them to be exposed to lead at a higher rate. While it's clear we can't fully solve this mystery given the data we have, the identification of these somewhat unexpected "high lead" tracts is crucial as it can help direct resources and information toward these tracts in order to reduce lead exposure.

```{r, eval=FALSE}
lead_census %>%
  mutate(highleadNewHome = case_when(HighLead == "1" & propHomesBuiltPre1950 <= 0.25 ~ 2, 
                                     HighLead == "1" & propHomesBuiltPre1950 > 0.25 ~ 1,
                                     TRUE ~ 0), 
         area = st_area(geometry),
         density = PopE/area) %>%
   st_drop_geometry() %>%
  group_by(highleadNewHome) %>%
  summarize(mean(PopE), mean(medageE), pre1950 = mean(propHomesBuiltPre1950, na.rm=TRUE), from50to69 = mean(propHomesBuilt1950to1969, na.rm=TRUE),from70to79 = mean(propHomesBuilt1970to1979, na.rm=TRUE), mean(propHomesBuilt1970to1989, na.rm=TRUE), mean(propHomesBuilt1990to2009, na.rm=TRUE), mean(propHomesBuilt2010tonow, na.rm=TRUE), mean(SSIRecpE, na.rm=TRUE), mean(medincomeE, na.rm=TRUE), mean(density, na.rm=TRUE), before79 = sum(pre1950, from50to69, from70to79)) 
```

## Who is getting tested?

# Modeling the percent of children by census tract with EBLLs

Thus far, we have developed a model to predict whether or not a census tract will have at least 1% of tests return with an indication of EBLLs. But its important to acknowledge that not all census tracts that we have denoted as "high lead" have the same proportion of tests indicating EBLLs. For the 106 "high lead" tracts, the distribution of the proportion of tests indicating EBLLs is shown below. 

```{r}
dotplot <- lead_census %>%
  filter(HighLead == "1") %>%
  mutate(outlier = case_when(percent >= 0.1 ~ 1, 
                             TRUE ~ 0)) %>%
  ggplot(aes(x=percent, fill = as.factor(outlier)))+
  geom_dotplot(dotsize = 0.9)+
  theme_classic()+
  scale_fill_manual(values = c("black","darkred"))+
  scale_x_continuous(breaks = c(0.01, 0.03, 0.05, 0.07, 0.09, 0.11), labels = scales::percent_format(accuracy = 1)) +
  labs(x="", y="", title = "Percent of tests having EBLLs for the 106 <strong><span style='color:red'>high lead </span></strong></b>census tracts")+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"), 
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        legend.position = "none")

ramsey <- lead_census %>%
  filter(primary_county == "Ramsey County") %>%
  ggplot()+
  geom_sf(aes(fill=percent), lwd = 0.2, color = "black")+
  theme_classic()+
  labs(title = "", fill = "")+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(),
        legend.position = "none", 
        plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size=8),
        legend.title = element_text(family="mono"))+
  scale_fill_gradient(low = "white", high = "darkred")

library(cowplot)
  ggdraw() +
  draw_plot(dotplot) +
  draw_plot(ramsey, x = 0.5, y = .3, width = .5, height = .5)+
    annotate(geom="text", label = "Two outlier \ncensus tracts in \nRamsey county", family = "mono", size = 3, x = 0.76, y = 0.28, color = "darkred")+
    geom_curve(aes(x = 0.75, y = 0.2, xend = 0.85, yend = 0.15),
  arrow = arrow(length = unit(0.03, "npc")), color = "darkred")
```

In order to better understand this distribution and what is correlated with certain tracts having a higher percentage of tests with EBLLs than others, we will build a model for this percentage using solely the 106 "high lead" tracts. Similar to our logistic model building process to predict whether or not a tract is "high lead", we will begin with a LASSO regression model. Variables that remain in the model after the shrinkage process can be thought of as most important at helping us identify why certain tracts have a higher percentage of tests with EBLLs than others.

```{r, results = "hide", include=FALSE}
lasso_percent_variables <- lead_census %>%
  mutate(HighLead = as.factor(HighLead), 
         HighLead = relevel(factor(HighLead), ref="0"), 
         testRatio = tested/numChildtestingage, 
         area = st_area(geometry),
         density = PopE/area) %>% 
  select(HighLead, medageE, medincomeE, NumHouseE, PopE, propFamilyHouseholds, propHomesBuiltPre1950, SSIRecpE, CensusAgeE, tested, MarrCoupleChldU3E, testRatio, GEOID, propHomesBuilt1950to1969, propHomesBuilt1970to1989, propHomesBuilt1990to2009, propHomesBuilt2010tonow, percent, density) %>%
  filter(HighLead == "1") %>%
  drop_na() %>% st_drop_geometry()

set.seed(123)
percent_cv10 <- vfold_cv(lasso_percent_variables, v = 10)

lm_lasso_spec_tune <- 
  linear_reg() %>%
  set_args(mixture = 1, penalty = tune()) %>% 
  set_engine(engine = 'glmnet') %>%
  set_mode('regression') 

percent_rec <- recipe(percent ~., data = lasso_percent_variables) %>%
  update_role(GEOID, new_role = "ID") %>% # we don't want to use ID as predictor
  step_novel(all_nominal_predictors()) %>% 
  step_dummy(all_nominal_predictors()) %>% 
  step_nzv(all_predictors()) %>%
  step_normalize(all_numeric_predictors())  # important step for LASSO

lasso_wf_percent <- workflow() %>% 
  add_recipe(percent_rec) %>%
  add_model(lm_lasso_spec_tune) 

penalty_grid <- grid_regular(
  penalty(range = c(-5, 3)), #log10 transformed 10^-5 to 10^3
  levels = 50)

tune_res <- tune_grid( # new function for tuning hyperparameters
  lasso_wf_percent, # workflow
  resamples = percent_cv10, # folds
  metrics = metric_set(rmse),
  grid = penalty_grid # penalty grid
)

autoplot(tune_res)

collect_metrics(tune_res) %>%
  filter(.metric == 'rmse') %>%
  select(penalty, rmse = mean) 

best_penalty <- select_best(tune_res, metric = 'rmse', desc(penalty)) 
percent_final_wk <- finalize_workflow(lasso_wf_percent, best_penalty) # incorporates penalty value to workflow
percent_final_fit <- fit(percent_final_wk, data = lasso_percent_variables)
tidy(percent_final_fit)

percent_final_fit %>% predict(new_data = lasso_percent_variables)

# we can predict the percent of high lead children on average within 1.5% 
tune_res %>% collect_metrics() %>% filter(penalty == (best_penalty %>% pull(penalty)))

lasso_mod_out <- percent_final_fit %>%
    predict(new_data = lasso_percent_variables) %>%
    bind_cols(lasso_percent_variables) %>%
    mutate(resid = percent - .pred)

lasso_mod_out %>% 
  ggplot(aes(x = .pred, y = resid)) + 
  geom_point() +
  geom_smooth(se = FALSE) + 
  geom_hline(yintercept = 0) + 
  theme_classic()
```

Using 10-fold cross validation on our 106 census tracts, the LASSO modeling process identified tract population, the proportion of homes built between 1950 and 1969, the proportion of homes built before 1950, and the estimated mean receipt of supplemental security income (SSI) for households with children under 18 as the most important predictors of percentage of tests with EBLLs. Interestingly, population and amount of SSI both showed a negative relationship with percentage of tests with EBLLs, meaning more highly populated tracts tend to have a lower proportion of tests with EBLLs holding other variables constant. Additionally, tracts receiving more SSI tend to have a lower proportion of tests with EBLLs holding other variables constant. These relationships are shown in the plots below. 

```{r, out.width='45%'}
lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=PopE, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "Tract population vs percent of tests with EBLLs", x="", y="")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"))

lead_census %>%
  filter(HighLead == "1") %>%
  ggplot(aes(x=SSIRecpE, y=percent))+
  geom_point()+
  theme_classic()+
  labs(title = "SSI Reciepts ($) vs percent of tests with EBLLs", x="", y="")+
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
  theme(plot.title.position = "plot", 
        plot.title = element_markdown(family = "mono", size = 10), 
        axis.text = element_markdown(family = "mono"))
```

The reasoning for this phenomena could be that such higher populated and impoverished tracts are viewed "higher risk" for lead exposure and have received greater resources to prevent it thus far.

Now that we have our model, we can evaluate it. Looking first at our prediction errors, the model appears relatively solid with a mean estimated error of 1.5%. While this is good news, our model must also have residuals that do not have spatial autocorrelation. Spatial autocorrelation means residuals in one census tract are related to the residuals in the census tracts around it, which is problematic because we violate the assumption of independence of residuals and jeopardize the validity of hypothesis tests. We can test for spatial autocorrelation with something called the Moran's I test. In order to run the Moran's I test, we must decide in what way we want to define census tracts as "close". In other words, we must define a **neighborhood structure**. There are many options when defining a neighborhood structure. We can define tracts as neighbors if they touch at all, even just at a on point such as a corner. This is called the Queen neighborhood structure. Another option is the Rook neighborhood structure, which defines tracts as neighbors if they share an edge (more than just a corner). Neighbors can also be defined using distance. The KNN method calculates the distance between the centers (or centroids) of each census tract, and then defines a neighborhood based on K nearest tracts, distanced based on the centers [@heggeseth_2022]. Because we are only looking at census tracts with high lead levels, some tracts do not touch and thus we will use the KNN structure with 4 neighbors. 4 neighbors gives a nice balance between not having too many neighbors (which makes census tracts almost always correlated) and not having too few neighbors, making it harder to pick up on spatial correlation. The KNN(4) structure is shown below. 

```{r}
lasso_results <- lead_census %>%
  filter(HighLead == 1) %>%
  select(GEOID) %>%
  right_join(lasso_mod_out, by = "GEOID")

high_metro_centroids <- st_centroid(st_geometry(lasso_results), of_largest_polygon = TRUE)
knn <- knn2nb(knearneigh(high_metro_centroids, k = 4))
nb_knn_net <- nb2lines(nb = knn, coords = high_metro_centroids, as_sf = TRUE)

lasso_results %>%
  select(resid) %>%
  st_join(lead_census,.) %>%
    ggplot() + 
  geom_sf(size=.05,fill='white') + 
  geom_sf(data = lasso_results,fill = "lightblue",size=.1) + 
  geom_sf(data=high_metro_centroids, lwd = 0.5)+
  geom_sf(data = nb_knn_net, lwd = 0.25)+
  labs(title = "KNN(4) Neighborhood Structure for High Lead Tracts", fill = "") + 
  theme_classic()+
  theme(axis.line = element_blank(), 
        axis.text = element_blank(), 
        axis.ticks = element_blank(), 
        plot.title = element_text(family = "mono", size =11), 
        plot.title.position = "plot")

Wb <- nb2listw(knn, style = "B") #style = 'B' gives binary weights
spdep::moran.test(lasso_results$resid, Wb, alternative = "two.sided", randomisation = TRUE)  # Using randomization test
```

Using the Moran's I test with the KNN(4) structure shown above, there is very strong evidence to reject our null hypothesis of no spatial correlation between neighboring tracts. We thus conclude that census tracts closer together tend to have similar percentages of tests with EBLLs than census tracts further apart. Given this, we will need to use a model that accounts for this spatial autocorrelation. Two models that can potentially accomplish this are the **simultaneous autoregressive model (SAR)** and the **conditional autoregressive model (CAR)**. These models are fit in a similar way to an ordinary least squares model as we predict percent of tests with EBLLs using our selected variables, however, we add a component to the model that allows us to use surrounding neighborhood values at varying weights to estimate percentage of tests with EBLLs for each tract.  After fitting both a CAR and SAR model using the four variables selected by LASSO and the KNN(4) neighborhood structure, we compared them using BIC and the Moran's I test. From the Moran's I test we learned the SAR model yielded strong evidence in support of independent residuals. This evidence was significantly weaker for the CAR model, implying remaining spatial autocorrelation in the residuals. The BIC (a criterion for model selection) was also superior for the SAR model in comparison to the CAR model, and thus we decided to proceed with the SAR structure.

```{r, results="hide"}
library(spatialreg)

Ww <- nb2listw(knn, style = "W")
Wb <- nb2listw(knn, style = "B")

#SAR model
mod_sar <- spautolm(formula = percent~ PopE + propHomesBuiltPre1950 + SSIRecpE + propHomesBuilt1950to1969, data = lasso_results, listw = Ww, family = "SAR")
summary(mod_sar)
BIC(mod_sar)

lasso_results$mod_sar_knn <- resid(mod_sar)
spdep::moran.test(lasso_results$mod_sar_knn, Wb, alternative = "two.sided", randomisation = TRUE)

#CAR model 
mod_car <- spautolm(formula = percent~ PopE + propHomesBuiltPre1950 + SSIRecpE + propHomesBuilt1950to1969, data = lasso_results, listw = Ww, family = "CAR")
summary(mod_car)
BIC(mod_car)

lasso_results$mod_car_knn <- resid(mod_car)
spdep::moran.test(lasso_results$mod_car_knn, Wb, alternative = "two.sided", randomisation = TRUE)
```


# References 
